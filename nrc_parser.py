import logging
from IPython import embed
import sys
import os
from tqdm import tqdm
from rich.logging import RichHandler
import json
import datetime

logging.basicConfig(
    level="INFO",
    format="%(message)s",
    datefmt="[%X]",
    handlers=[RichHandler()]
)

log = logging.getLogger("NRC parser")
log.setLevel(logging.INFO)
log.info("Logger initialized")

except_list = ['activity-1074000000007250434630018621819844343451.json', 'activity-1094000000004561608200033534388667361415.json', 'activity-1412000000011379431580039612536084763296.json', 'activity-1632000000016191769420069062311121505993.json', 'activity-16cb53f9-937c-4041-ae7c-ac6bc61c697b.json', 'activity-17f4f728-d123-464a-bcb5-1f208f7e4d64.json', 'activity-1824000000010459271200039434175415933464.json', 'activity-185bc0ad-05eb-4a40-9946-73a8e0a59e38.json', 'activity-1e85014d-80ce-4e2c-9508-a9c512d0119a.json', 'activity-2007811241.json', 'activity-2008548473.json', 'activity-2012783856.json', 'activity-2013660209.json', 'activity-2020176758.json', 'activity-2022330421.json', 'activity-2023322124.json', 'activity-2025678466.json', 'activity-2054246295.json', 'activity-2056803729.json', 'activity-2075191026.json', 'activity-2076526219.json', 'activity-20774743000.json', 'activity-20774799000.json', 'activity-2077490072.json', 'activity-2079920798.json', 'activity-2084499048.json', 'activity-2085559946.json', 'activity-2085571101.json', 'activity-2091226426.json', 'activity-2092134250.json', 'activity-2095877816.json', 'activity-2107000000006628035250037609438808477510.json', 'activity-2108217994.json', 'activity-2108232082.json', 'activity-2110119889.json', 'activity-2113329566.json', 'activity-2114613180.json', 'activity-2115679349.json', 'activity-2115681290.json', 'activity-2118874030.json', 'activity-2120654323.json', 'activity-2120654324.json', 'activity-2120657291.json', 'activity-2122316100.json', 'activity-2123794716.json', 'activity-2124000000004441682480000307445174872694.json', 'activity-2124382284.json', 'activity-2127044468.json', 'activity-2134551619.json', 'activity-2134555483.json', 'activity-2141439686.json', 'activity-2407000000016930041170014121422849258160.json', 'activity-24304495000.json', 'activity-2724000000013749990620004235736764437680.json', 'activity-28239691000.json', 'activity-2984000000008470973650006108924794062249.json', 'activity-298ee1c5-ff53-4658-b119-fd2bdfa6a5d2.json', 'activity-2997000000010422020980002155001918333605.json', 'activity-29de5a48-565b-4232-9331-1a64b3df9dd2.json', 'activity-30959654000.json', 'activity-3141000000008430940300005664765150950325.json', 'activity-3149000000005670869840001297189941232458.json', 'activity-3183000000013699951490009627836722305223.json', 'activity-3269d396-e54e-41d8-a4cc-7e84e22b615f.json', 'activity-3405000000018256719860001228105858504506.json', 'activity-3424445000.json', 'activity-3550000000011137381510009710927563335445.json', 'activity-3658000000001563473360069318135624200681.json', 'activity-3752000000015683896910053604869166331723.json', 'activity-3778000000010417531900058849002094148421.json', 'activity-3843000000003410484490060423853411502538.json', 'activity-3b33a3fd-bc38-4926-9bd6-bb59523af800.json', 'activity-3b803d98-eba5-4d0c-a2c6-40d08a984962.json', 'activity-3bc93356-0b26-4ddb-bfa8-a288043b246f.json', 'activity-3f6289f2-4bb7-41db-a6a7-61d00c1cdb4b.json', 'activity-40200459000.json', 'activity-40200480000.json', 'activity-41538342000.json', 'activity-41538385000.json', 'activity-4189000000004004284350006045736863646301.json', 'activity-42480980175.json', 'activity-42491222732.json', 'activity-42491222745.json', 'activity-42491227247.json', 'activity-42491228173.json', 'activity-42492749344.json', 'activity-42496872666.json', 'activity-42496879219.json', 'activity-42501891146.json', 'activity-4265000000008171072190014728645718988458.json', 'activity-433263f4-501a-4a43-9a55-a36a7a3b97f2.json', 'activity-44275dfa-6622-42c7-9a0e-65afeca62644.json', 'activity-4483000000010894787180002321782860432302.json', 'activity-4498000000004247836780097049423894993997.json', 'activity-47306a4a-3887-41ae-a680-c3e79c522732.json', 'activity-4950000000014732863530005564296731028488.json', 'activity-4b7e62e3-cd42-408d-8282-4fe92b7f24bc.json', 'activity-4fc034b5-b20c-41d7-9a8a-d92f4e279e72.json', 'activity-5089000000013905988500023401204228199168.json', 'activity-5232000000012174244930012319663223965013.json', 'activity-52f56c90-964e-49dd-a1d1-3f4dbb433cab.json', 'activity-534fbfae-f969-428f-a161-3de554bc6127.json', 'activity-5458fc3d-13ec-4eff-a229-747d6666420b.json', 'activity-5583000000013051915340076925109437046817.json', 'activity-56795ba6-f3b1-4119-9b0f-b18706f78ff2.json', 'activity-5743000000015012464660066480867953049579.json', 'activity-59ea2ab7-728d-4217-9f77-d97cafc912f9.json', 'activity-5ade5056-ccf3-493c-8c6b-a1ee8d05f604.json', 'activity-5ecdfa76-4465-43da-8569-933b30f4cd3e.json', 'activity-61359c65-94d1-45ac-a482-c2a68c557337.json', 'activity-61b135d1-fa7f-4991-99af-56e8723e32be.json', 'activity-622ec9df-d3fe-4369-8086-f1ef8ac452d3.json', 'activity-6294000000006640853400057374578220938111.json', 'activity-6487000000011517103040005275012664812731.json', 'activity-6525000000006750145800018994854806446950.json', 'activity-680b4bde-1f7d-44cf-88a9-27bfc1d7c2c7.json', 'activity-6815000000016115717220013870240382550670.json', 'activity-6889000000021386510070039517432828030632.json', 'activity-6959000000018822490230048351384670045688.json', 'activity-698944981.json', 'activity-698944988.json', 'activity-699234007.json', 'activity-699343894.json', 'activity-699343906.json', 'activity-699343931.json', 'activity-699343943.json', 'activity-699343954.json', 'activity-699542431.json', 'activity-699542441.json', 'activity-699542447.json', 'activity-699542450.json', 'activity-699542453.json', 'activity-699640378.json', 'activity-699640382.json', 'activity-699741859.json', 'activity-699839654.json', 'activity-6c322e3e-dbcf-4832-97f8-f5240f61c377.json', 'activity-7104000000005342316190014313918845681000.json', 'activity-7169000000002018083810005664799126707393.json', 'activity-7188000000011814352190048351052280055737.json', 'activity-72303505-3038-4469-a9a5-2fd80232c37c.json', 'activity-735227502.json', 'activity-736565622.json', 'activity-738609433.json', 'activity-738809822.json', 'activity-739363542.json', 'activity-7538000000016085341700095057895990535728.json', 'activity-778758086.json', 'activity-780527084.json', 'activity-783404454.json', 'activity-787507327.json', 'activity-791009306.json', 'activity-7ab07d53-c3a0-4bc1-8fad-94934cf99227.json', 'activity-7e010ebf-2096-4496-b858-0f371623c320.json', 'activity-7f729436-6315-471e-9d49-135275124bb2.json', 'activity-7f9cac19-605d-47a6-b2a8-6833d1092a28.json', 'activity-8075000000000787806680005664759786003522.json', 'activity-816602459.json', 'activity-816637374.json', 'activity-8177000000004143842170058923505017572864.json', 'activity-8177000000016268513730058923505017597882.json', 'activity-8178000000021464390910003839023447035503.json', 'activity-820105019.json', 'activity-827252628.json', 'activity-827288480.json', 'activity-830303327.json', 'activity-834100454.json', 'activity-843842698.json', 'activity-8461000000015166758370068031895006736144.json', 'activity-8578000000016273990140091251447453528323.json', 'activity-867360286.json', 'activity-869f418c-543d-40d9-93f9-2d2075b2a468.json', 'activity-876032533.json', 'activity-879008158.json', 'activity-879162892.json', 'activity-885580537.json', 'activity-893049784.json', 'activity-893324435.json', 'activity-893878331.json', 'activity-8d91337d-9741-4e5b-9153-4b335f3067f6.json', 'activity-9142000000010397357100097596572858716464.json', 'activity-9428000000009023003670066458986835668984.json', 'activity-9448000000001706098170089000813267484045.json', 'activity-94bc37d7-01e8-4edf-a6c1-2ec79b0c3875.json', 'activity-95f14eda-7822-467b-a6c1-6aca27d1bf6d.json', 'activity-9735000000001863763800000750812731582250.json', 'activity-9798000000018548127200007853960945376080.json', 'activity-9b626e46-8b8d-4018-a701-823a536259a7.json', 'activity-a25633a0-edfd-4eef-9a97-428fe99046b2.json', 'activity-a45fc47e-4a3f-45c9-9f5b-e6ecb63342ef.json', 'activity-a4bc010f-86f3-466a-9d47-e95944ca5a99.json', 'activity-a7831e8c-3507-4f6d-95f0-a1d3a32e6ffa.json', 'activity-a8dff759-1492-49c4-b3b5-b87f4ed222ac.json', 'activity-a93f8b78-ba89-47c2-ab3d-15c8d1a3b69c.json', 'activity-b1cadd99-83b6-4ea4-a6ee-21d1dacf1e71.json', 'activity-b2c3cb57-4121-4e48-b184-54900e38b18e.json', 'activity-b40568aa-106a-40f6-bf65-19bda98d40ee.json', 'activity-b611fcb5-b268-483c-936b-db81ae9a867b.json', 'activity-c1496f56-3c14-4cd8-9199-a8d95cade051.json', 'activity-c29d3fed-d66b-47eb-86e2-ed7a9d6d983c.json', 'activity-c7b41b30-948e-4cd1-aad8-22af981b4632.json', 'activity-d2cf7bdb-b441-4cbb-a14e-809c09ebcec3.json', 'activity-d40729cc-c9b5-45c8-b7b1-55b6153a9af6.json', 'activity-d75d93b9-9312-43dd-8156-23bc4b5c6cbb.json', 'activity-dace3e26-2132-4ebc-9b41-3d86c7028292.json', 'activity-e9cdc2db-29ec-4a46-8958-cc7998befca9.json', 'activity-ee24b356-d888-4c90-9b3e-e09f0e63f4f1.json', 'activity-ee256766-b574-4617-bf08-af6042b365b3.json', 'activity-f8916777-3fb0-4bb2-a578-2436988dee73.json', 'activity-01589d6d-4d7d-4d4b-9d2c-60a128cdd9b0.json', 'nrc_parser.py', 'README.md', '.gitignore', '.git']

files = [file for file in os.listdir() if file not in except_list]
error_files = []
date_files = []

for file in tqdm(files, desc="Parsing activities...", unit_scale=True):
    with open(file, "r") as f:
        data = f.read()
        df = json.loads(data)
        try:
            for x in df['activities']:
                    start = datetime.datetime.fromtimestamp(x['start_epoch_ms']/1000)
                    stop = datetime.datetime.fromtimestamp(x['end_epoch_ms']/1000)
                    log.info(f"Start: {start} Stop: {stop} Emotion: {x['tags'].get('emotion', 'None')} Note: {x['tags'].get('note', 'None')}")
        except KeyError:
            try:
                start = datetime.datetime.fromtimestamp(x['start_epoch_ms']/1000)
                stop = datetime.datetime.fromtimestamp(x['end_epoch_ms']/1000)
                log.info(f"Start: {start} Stop: {stop} Emotion: {x['tags'].get('emotion', 'None')} Note: {x['tags'].get('note', 'None')}")
                if start.date() == datetime.date(2021,5,20):
                    date_files.append(file)
            except Exception as e:
                log.error(e)
                error_files.append(file)
                embed()
                continue
        except Exception as e:
            log.error(e)
            embed()
